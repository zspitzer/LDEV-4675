name: Test Lucee admin Upgrade

on:
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:
  push:

jobs:
  test-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Cache Maven packages
        uses: actions/cache@v3
        with:
          path: ~/.m2
          key: lucee-script-runner-maven-cache
      - name: Cache Lucee files
        uses: actions/cache@v3
        with:
          path: |
            _actions/lucee/script-runner/main/lucee-download-cache
            ./*.run
            ./*.lco
          key: lucee-downloads
      - name: install 5.4.2.17
        env:
          LUCEE_ADDITIONAL_CONFIG: true
          LUCEE_ADDITIONAL_CONFIG_SERVER_DIR: ${{ github.workspace }}
        run: |
          curl --fail https://cdn.lucee.org/lucee-5.4.2.17-linux-x64-installer.run -o lucee-linux-x64-installer.run
          pwd
          ls -lah

          #mkdir -p /tmp/lucee/tomcat/lucee-server/context
          #cp .CFConfig.json /tmp/lucee/tomcat/lucee-server/context/.CFConfig.json
          #cp lucee-server.xml /tmp/lucee/tomcat/lucee-server/context/lucee-server.xml
          #echo "webweb" /tmp/lucee/tomcat/lucee-server/context/password.txt

          mkdir -p /tmp/lucee/tomcat/webapps/ROOT/WEB-INF/lucee
          cp lucee-web.xml.cfm /tmp/lucee/tomcat/webapps/ROOT/WEB-INF/lucee/lucee-web.xml.cfm

          chmod +x lucee-linux-x64-installer.run
          sudo ./lucee-linux-x64-installer.run \
            --mode unattended --prefix /tmp/lucee --installconn false --installmodcfml false --installiis false --startatboot false \
            --luceepass webweb --systemuser $USER --installjre true
          sleep 5;
          ls -lha /tmp/lucee/tomcat/lucee-server/context
          echo "<cfscript>if (server.lucee.version neq url.version) header statuscode='500' statustext='wrong version #server.lucee.version#'; echo('## Lucee Linux ' & server.lucee.version & ', using java ' & server.java.version);</cfscript>" > /tmp/lucee/tomcat/webapps/ROOT/check.cfm
          curl http://127.0.0.1:8888/check.cfm?version=5.4.2.17 --fail-with-body -o $GITHUB_STEP_SUMMARY
          #sleep 5
          #sudo /tmp/lucee/lucee_ctl stop
          #ls -lRHa /tmp/lucee/tomcat/lucee-server
          #cat /tmp/lucee/install.log
      - name: debug initial install failure
        if: success() || failure()
        run: |
            echo "-----------catalina.out"
            cat /tmp/lucee/tomcat/logs/catalina.out
            echo "-----------out.log"
            cat /tmp/lucee/tomcat/lucee-server/context/logs/out.log
            cat /tmp/lucee/install.log
      - name: Checkout Lucee
        uses: actions/checkout@v3
        with:
          repository: lucee/lucee
          path: lucee
      - name: Run Lucee Test Suite, testFilter="adminPages" 5.4.2.17
        uses: lucee/script-runner@main
        with:
          webroot: ${{ github.workspace }}/lucee/test
          execute: /bootstrap-tests.cfm
          luceeVersionQuery: 6/all/light
        env:
          testFilter: remoteAdminPages
          testAdditional: ${{ github.workspace }}/tests
      - name: Upgrade Lucee to 5.4.3.5-SNAPSHOT via lco
        run: |
            curl --fail https://cdn.lucee.org/5.4.3.5-SNAPSHOT.lco -o 5.4.3.5-SNAPSHOT.lco
            cp 5.4.3.5-SNAPSHOT.lco /tmp/lucee/tomcat/lucee-server/deploy/5.4.3.5-SNAPSHOT.lco
            ls -lR /tmp/lucee/tomcat/lucee-server/deploy
            echo "sleeping for 70s"
            sleep 70
            ls -lR /tmp/lucee/tomcat/lucee-server/deploy
            curl http://127.0.0.1:8888/check.cfm?version=5.4.3.5-SNAPSHOT --fail-with-body -o $GITHUB_STEP_SUMMARY
      - name: debug upgrade failure
        if: success() || failure()
        run: |
            #ls -lRa /tmp/lucee/tomcat/lucee-server/deploy
            #ls -lRh /tmp/lucee/tomcat/lucee-server/patches
            ls -lRh /tmp/lucee/tomcat/lucee-server/context/logs
            ls -lRh /tmp/lucee/tomcat/logs/
            echo "-----------server out.log"
            cat /tmp/lucee/tomcat/lucee-server/context/logs/out.log
            echo "-----------server err.log"
            cat /tmp/lucee/tomcat/lucee-server/context/logs/err.log
            echo "-----------server deploy.log"
            cat /tmp/lucee/tomcat/lucee-server/context/logs/deploy.log
            echo "-----------server exception.log"
            cat /tmp/lucee/tomcat/lucee-server/context/logs/exception.log
            echo "-----------catalina.out"
            cat /tmp/lucee/tomcat/logs/catalina.out
            echo "-----------Web application.log
            cat /tmp/lucee/tomcat/webapps/ROOT/WEB-INF/lucee/logs/application.log
            echo "-----------Web exception.log
            cat /tmp/lucee/tomcat/webapps/ROOT/WEB-INF/lucee/logs/exception.log
      - name: Run Lucee Test Suite, testFilter="adminPages" 5.4.3.5-SNAPSHOT
        uses: lucee/script-runner@main
        with:
          webroot: ${{ github.workspace }}/lucee/test
          execute: /bootstrap-tests.cfm
          luceeVersionQuery: 6/all/light
        env:
          testFilter: remoteAdminPages
          testAdditional: ${{ github.workspace }}/tests
      - name: debug failure - application.log TRACE
        if: success() || failure()
        run: |
            echo "------------Server application.log"
            cat /tmp/lucee/tomcat/lucee-server/context/logs/application.log
            echo "-----------server exception.log"
            cat /tmp/lucee/tomcat/lucee-server/context/logs/exception.log
            echo "------------Server out.log
            cat /tmp/lucee/tomcat/lucee-server/context/logs/out.log
            echo "------------Web application.log
            cat /tmp/lucee/tomcat/webapps/ROOT/WEB-INF/lucee/logs/application.log
            echo "-----------Web exception.log
            cat /tmp/lucee/tomcat/webapps/ROOT/WEB-INF/lucee/logs/exception.log
            ls -lR /tmp/lucee/tomcat/webapps/ROOT/WEB-INF/lucee/temp/compress

